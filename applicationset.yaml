apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: dev-apps
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions:
    - missingkey=error
  generators:
    - git:
        repoURL: https://github.com/Younesic/dev-apps.git
        revision: main
        files:
          - path: apps/dev/*/app.yaml
  template:
    metadata:
      name: '{{ .name }}'
      labels:
        platform.example.com/environment: dev
        platform.example.com/managed-by: applicationset
    spec:
      project: '{{ .project }}'
      source:
        repoURL: https://github.com/Younesic/platform-gitops.git
        targetRevision: main
        path: apps/templates/webapp/overlays/dev/default
        kustomize:
          namePrefix: '{{ .name }}-'
          namespace: '{{ .namespace }}'
          images:
            - 'example/app={{ .imageName }}:{{ .imageTag }}'
          replicas:
            - name: app
              count: '{{ .replicas }}'
          patches:
            - target:
                kind: ConfigMap
                name: app-config
              patch: |-
                apiVersion: v1
                kind: ConfigMap
                metadata:
                  name: app-config
                data:
                  config.yaml: |-
                    {{- range $k, $v := .config }}
                    {{ $k }}: "{{ $v }}"
                    {{- end }}
{{- if hasKey . "sealedSecret" }}
            - target:
                kind: SealedSecret
                name: '{{ default "app-secret" .sealedSecret.name }}'
              patch: |-
                apiVersion: bitnami.com/v1alpha1
                kind: SealedSecret
                metadata:
                  name: '{{ default "app-secret" .sealedSecret.name }}'
                spec:
                  template:
                    metadata:
                      name: '{{ default "app-secret" .sealedSecret.name }}'
                  encryptedData:
                    {{- range $k, $v := .sealedSecret.encryptedData }}
                    {{ $k }}: "{{ $v }}"
                    {{- end }}
{{- end }}
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{ .namespace }}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=false
